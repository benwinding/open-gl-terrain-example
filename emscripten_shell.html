<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OpenGL Demo - By Ben Winding</title>
    <style>
      html, body { margin: 0; height: 100%; width: 100%; background: #111; overflow: hidden; }
      canvas { width: 100vw; height: 100vh; display: block; }
      #audio-hint {
        position: absolute;
        top: 12px;
        left: 12px;
        padding: 8px 12px;
        background: rgba(0, 0, 0, 0.75);
        color: #f0f0f0;
        font-family: sans-serif;
        font-size: 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        user-select: none;
        z-index: 20;
      }
      #mobile-controls {
        position: absolute;
        left: 12px;
        bottom: 12px;
        display: grid;
        grid-template-columns: 52px 52px 52px;
        grid-template-rows: 52px 52px;
        gap: 8px;
        z-index: 15;
      }
      #mobile-controls button,
      #mobile-actions button {
        background: rgba(0, 0, 0, 0.6);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        font-size: 14px;
        font-family: sans-serif;
        width: 52px;
        height: 52px;
        touch-action: none;
      }
      #mobile-actions {
        position: absolute;
        right: 12px;
        bottom: 12px;
        display: grid;
        grid-auto-rows: 52px;
        gap: 8px;
        z-index: 15;
      }
    </style>
  </head>
  <body>
    <button id="audio-hint" type="button">Enable Sound</button>
    <div id="mobile-controls">
      <div></div>
      <button type="button" data-key="ArrowUp">▲</button>
      <div></div>
      <button type="button" data-key="ArrowLeft">◀</button>
      <button type="button" data-key="ArrowDown">▼</button>
      <button type="button" data-key="ArrowRight">▶</button>
    </div>
    <div id="mobile-actions">
      <button type="button" data-key="U">Look Up</button>
      <button type="button" data-key="D">Look Down</button>
      <button type="button" data-key="1">1st Person</button>
      <button type="button" data-key="2">Top View</button>
    </div>
    <canvas id="canvas" oncontextmenu="event.preventDefault()" tabindex="-1"></canvas>
    <audio id="bg-audio" src="res/sounds/Gilman_Mom_-_07_-_Cosmic_Evening.ogg" autoplay loop muted playsinline></audio>
    <script>
      var Module = {
        preRun: [],
        postRun: [],
        canvas: (function () {
          return document.getElementById('canvas');
        })(),
        onRuntimeInitialized: function () {
          var audio = document.getElementById('bg-audio');
          var hint = document.getElementById('audio-hint');
          var tryPlay = function () {
            audio.muted = false;
            audio.play().then(function () {
              if (hint) {
                hint.remove();
              }
            }).catch(function () {
            });
          };

          var resizeCanvas = function () {
            var canvas = Module.canvas;
            var width = window.innerWidth;
            var height = window.innerHeight;
            if (canvas) {
              canvas.style.width = width + 'px';
              canvas.style.height = height + 'px';
              canvas.width = width;
              canvas.height = height;
            }
          };
          window.addEventListener('resize', resizeCanvas);
          resizeCanvas();
          document.addEventListener('click', tryPlay, { once: true });
          document.addEventListener('keydown', tryPlay, { once: true });
          document.addEventListener('visibilitychange', function () {
            if (!document.hidden) {
              tryPlay();
            }
          });
          var sendKey = function (key, isDown) {
            var codeMap = {
              ArrowUp: 38,
              ArrowDown: 40,
              ArrowLeft: 37,
              ArrowRight: 39,
              U: 85,
              D: 68,
              "1": 49,
              "2": 50
            };
            var keyCode = codeMap[key] || 0;
            var event = new KeyboardEvent(isDown ? 'keydown' : 'keyup', {
              key: key,
              code: key,
              keyCode: keyCode,
              which: keyCode,
              bubbles: true
            });
            window.dispatchEvent(event);
            document.dispatchEvent(event);
          };

          var bindButton = function (button) {
            var key = button.getAttribute('data-key');
            if (!key) {
              return;
            }
            var press = function (event) {
              event.preventDefault();
              sendKey(key, true);
            };
            var release = function (event) {
              event.preventDefault();
              sendKey(key, false);
            };
            button.addEventListener('touchstart', press);
            button.addEventListener('touchend', release);
            button.addEventListener('touchcancel', release);
            button.addEventListener('mousedown', press);
            button.addEventListener('mouseup', release);
            button.addEventListener('mouseleave', release);
          };

          document.querySelectorAll('#mobile-controls button, #mobile-actions button').forEach(bindButton);

          window.addEventListener('focus', tryPlay);
          if (hint) {
            hint.addEventListener('click', tryPlay);
          }
          audio.play().catch(function () {
          });
        }
      };
    </script>
    {{{ SCRIPT }}}
  </body>
</html>
